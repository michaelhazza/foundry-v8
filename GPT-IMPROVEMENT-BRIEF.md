# GPT Code Generation Improvement Brief

**Generated by:** Code Review Agent v25
**Date:** 2026-01-20
**Purpose:** Provide actionable feedback to improve upstream code-generating agents
**Repository:** Foundry

---

## Executive Summary

The Foundry codebase audit identified **21 issues** (9 CRITICAL, 10 HIGH, 2 MEDIUM) that could have been prevented with better prompt engineering and validation in the code-generating agents. This brief categorizes the issues by root cause and provides specific recommendations for GPT prompt improvements.

---

## Issue Category 1: Route Path Syntax Errors

### What Happened
4 routes had malformed path strings that would cause runtime 404 errors.

### Specific Issues

| File | Line | Incorrect | Correct |
|------|------|-----------|---------|
| organizations.routes.ts | 186 | `/current/members:userId` | `/current/members/:userId` |
| organizations.routes.ts | 233 | `/current/members:userId/role` | `/current/members/:userId/role` |
| sources.routes.ts | 203 | `/projects:projectId/sources` | `/projects/:projectId/sources` |
| sources.routes.ts | 343 | `:sourceId/configuration` | `/:sourceId/configure` |

### Root Cause Analysis
The GPT appears to have:
1. Omitted the `/` character before route parameters in some cases
2. Omitted the leading `/` in one route path
3. These look like tokenization/spacing issues during generation

### Recommended Prompt Improvements

```markdown
## Route Definition Rules (CRITICAL)

When defining Express routes, ALWAYS follow these patterns:

1. **Route parameters MUST be preceded by a slash:**
   - ✓ CORRECT: `router.get('/users/:userId', ...)`
   - ✗ WRONG: `router.get('/users:userId', ...)`

2. **All route paths MUST start with a slash:**
   - ✓ CORRECT: `router.get('/:id', ...)`
   - ✗ WRONG: `router.get(':id', ...)`

3. **Self-validation checkpoint:**
   Before finishing any route file, scan all `router.get/post/put/patch/delete` calls
   and verify each path:
   - Starts with `/`
   - Has `/` before every `:paramName`
   - Matches the API Contract specification exactly

4. **Example validation:**
   ```typescript
   // For endpoint: DELETE /api/organizations/members/:userId
   // Route path should be: '/members/:userId' (when mounted at /api/organizations)

   // WRONG - missing slash before :userId
   router.delete('/members:userId', ...)

   // CORRECT
   router.delete('/members/:userId', ...)
   ```
```

---

## Issue Category 2: HTTP Method Mismatches

### What Happened
3 endpoints used the wrong HTTP method compared to the API Contract specification.

### Specific Issues

| Endpoint | Spec Says | Implementation Uses |
|----------|-----------|---------------------|
| PATCH /api/organizations/current | PATCH | PUT |
| PATCH /api/projects/:projectId | PATCH | PUT |
| POST /api/sources/:sourceId/configure | POST | PUT |

### Root Cause Analysis
The GPT may have:
1. Defaulted to PUT for update operations without checking the spec
2. Not cross-referenced the API Contract document during implementation
3. Confused PATCH (partial update) with PUT (full replacement)

### Recommended Prompt Improvements

```markdown
## HTTP Method Selection Rules (CRITICAL)

1. **ALWAYS cross-reference the API Contract before implementing any endpoint**
   - The API Contract is the source of truth for HTTP methods
   - Do not assume based on operation type

2. **Method semantics reminder:**
   - `POST`: Create new resource OR trigger action
   - `GET`: Read/retrieve resource
   - `PUT`: Full replacement of resource (rarely used)
   - `PATCH`: Partial update of resource (preferred for updates)
   - `DELETE`: Remove resource

3. **Validation checkpoint:**
   For each route implementation, verify:
   ```
   API Contract says: [METHOD] /api/path
   Implementation uses: router.[method]('/path', ...)

   Do these match? If not, fix the implementation.
   ```

4. **Common mistake to avoid:**
   If the API Contract says PATCH, do NOT use PUT even if "it would work."
   Frontend clients will use the method from the API Contract.
```

---

## Issue Category 3: Missing API Endpoints

### What Happened
2 endpoints from the API Contract were not implemented at all.

### Missing Endpoints

| # | Endpoint | Purpose | Impact |
|---|----------|---------|--------|
| 7 | PATCH /api/auth/profile | Update user profile | Users cannot update their name/password |
| 9 | GET /api/auth/reset-password/:token | Validate reset token | Password reset flow broken |

### Root Cause Analysis
The GPT likely:
1. Skipped these endpoints during implementation
2. Did not have a systematic checklist to verify all endpoints were covered
3. May have confused POST /reset-password with GET /reset-password/:token

### Recommended Prompt Improvements

```markdown
## Endpoint Coverage Verification (CRITICAL)

1. **Before starting implementation:**
   - Count total endpoints in API Contract: `grep -c "| [0-9]* |" docs/04-API-CONTRACT.md`
   - Create a checklist of all endpoints

2. **During implementation:**
   - Mark each endpoint as implemented when complete
   - Do NOT consider a route file "done" until all endpoints for that resource are implemented

3. **Auth endpoints checklist (common source of gaps):**
   ```
   [ ] POST /api/auth/register
   [ ] POST /api/auth/login
   [ ] POST /api/auth/refresh
   [ ] POST /api/auth/logout
   [ ] GET /api/auth/me
   [ ] PATCH /api/auth/profile        <- OFTEN MISSED
   [ ] POST /api/auth/forgot-password
   [ ] GET /api/auth/reset-password/:token  <- OFTEN MISSED (validates token)
   [ ] POST /api/auth/reset-password  <- (processes reset)
   ```

4. **Final verification:**
   After implementing all routes, run:
   ```bash
   grep -c "router\.(get|post|patch|put|delete)" server/routes/*.ts
   ```
   Compare count to API Contract endpoint count.
```

---

## Issue Category 4: Inconsistent Parameter Parsing

### What Happened
2 locations used `parseInt()` directly on URL parameters instead of the standard `parseIntParam()` utility.

### Specific Issues

| File | Line | Incorrect Pattern |
|------|------|-------------------|
| organizations.routes.ts | 192 | `parseInt(req.params.userId as string, 10)` |
| organizations.routes.ts | 240 | `parseInt(req.params.userId as string, 10)` |

### Why This Matters
- `parseInt()` returns `NaN` for invalid input, requiring manual checking
- `parseIntParam()` throws a proper `BadRequestError` with consistent error format
- Inconsistent error handling breaks API contract guarantees

### Root Cause Analysis
The GPT:
1. Generated inline parseInt instead of using the established utility
2. Did not maintain consistency with other route files
3. May not have been aware of the parseIntParam utility

### Recommended Prompt Improvements

```markdown
## Parameter Parsing Rules (CRITICAL)

1. **NEVER use parseInt() directly on route parameters**
   ```typescript
   // WRONG - Don't do this
   const id = parseInt(req.params.id as string, 10);
   if (isNaN(id)) {
     throw new BadRequestError('Invalid ID');
   }

   // CORRECT - Always use parseIntParam
   import { parseIntParam } from '../lib/validation';
   const id = parseIntParam(req.params.id, 'id');
   ```

2. **Before writing any route handler, check existing utilities:**
   - `parseIntParam(param, paramName)` - For numeric URL params
   - `parsePaginationParams(req)` - For page/pageSize query params
   - `validateProjectId`, `validateSourceId`, etc. - For resource access validation

3. **Consistency checkpoint:**
   Search for `parseInt(req.params` in the codebase:
   ```bash
   grep -rn "parseInt(req.params" server/routes/
   ```
   If any matches found, replace with parseIntParam.
```

---

## Issue Category 5: Incomplete Implementations (TODOs)

### What Happened
6 TODO comments in production code indicate incomplete implementations.

### Specific TODOs

| File | Line | TODO Content | Severity |
|------|------|--------------|----------|
| auth.routes.ts | 150 | Handle invite token - join existing organization | HIGH |
| auth.routes.ts | 445 | Send email with reset link | HIGH |
| integrations.routes.ts | 204 | Encrypt access token | HIGH (Security) |
| integrations.routes.ts | 205 | Encrypt refresh token | HIGH (Security) |
| integrations.routes.ts | 272 | Implement actual Teamwork API call | HIGH |
| organizations.routes.ts | 169 | Generate invite token and send email | HIGH |

### Root Cause Analysis
The GPT:
1. Generated placeholder code with TODO comments
2. Did not implement the full functionality
3. May have hit complexity limits or token limits

### Recommended Prompt Improvements

```markdown
## TODO Prohibition Rules (CRITICAL)

1. **Production code MUST NOT contain TODO comments**
   - Every feature must be fully implemented
   - If a feature cannot be implemented, it should be stubbed with proper error handling

2. **For optional features (e.g., email when SENDGRID_API_KEY not set):**
   ```typescript
   // WRONG - TODO comment
   // TODO: Send email with reset link
   console.log(`Reset token: ${resetToken}`);

   // CORRECT - Graceful degradation with proper handling
   if (isEmailEnabled()) {
     await sendPasswordResetEmail(user.email, resetToken);
   } else {
     // In development without email, log the token
     if (config.isDevelopment) {
       console.log(`[DEV] Password reset token for ${email}: ${resetToken}`);
     }
     // Production without email configured is a misconfiguration
     // but we don't expose the token - user must configure email
   }
   ```

3. **For security-critical operations (e.g., token encryption):**
   ```typescript
   // WRONG - Storing plaintext with TODO
   encryptedAccessToken: tokenData.access_token, // TODO: Encrypt

   // CORRECT - Implement encryption or throw error
   import crypto from 'crypto';

   function encryptToken(token: string): string {
     const algorithm = 'aes-256-gcm';
     const key = Buffer.from(config.encryptionKey, 'hex');
     const iv = crypto.randomBytes(16);
     const cipher = crypto.createCipheriv(algorithm, key, iv);
     const encrypted = Buffer.concat([cipher.update(token, 'utf8'), cipher.final()]);
     const authTag = cipher.getAuthTag();
     return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted.toString('hex')}`;
   }

   encryptedAccessToken: encryptToken(tokenData.access_token),
   ```

4. **Self-check before completion:**
   ```bash
   grep -rn "// TODO:" server/ client/
   ```
   If any results in implementation files, the code is not production-ready.
```

---

## Issue Category 6: CSS Framework Syntax

### What Happened
The CSS file used Tailwind v3 syntax when Tailwind v4 syntax may be expected.

### Specific Issue

```css
/* Found in client/src/index.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Tailwind v4 syntax would be: */
@import "tailwindcss";
```

### Root Cause Analysis
- Package.json shows tailwindcss@^3.4.17 which uses v3 syntax
- The spec/QA document may have specified v4
- Inconsistency between dependency version and expected syntax

### Recommended Prompt Improvements

```markdown
## CSS Framework Version Alignment (MEDIUM)

1. **Check package.json for Tailwind version:**
   - tailwindcss@^3.x.x → Use `@tailwind base/components/utilities`
   - tailwindcss@^4.x.x → Use `@import "tailwindcss"`

2. **Consistency rule:**
   The CSS syntax MUST match the installed package version.
   Do not mix v3 and v4 patterns.

3. **Verification:**
   ```bash
   # Check installed version
   grep "tailwindcss" package.json

   # Check CSS syntax
   head -5 client/src/index.css
   ```
   Ensure these are compatible.
```

---

## Issue Category 7: Missing UI Pages

### What Happened
Only 9 of 19 specified UI pages were implemented.

### Missing Pages

| Page | Purpose | Required By |
|------|---------|-------------|
| AcceptInvitePage | Handle team invitation acceptance | Invitation flow |
| ProfileSettingsPage | User profile management | Profile update endpoint |
| TeamManagementPage | Organization member management | Admin functionality |
| SourceUploadPage | File upload for sources | Source creation flow |
| SourceMappingPage | Field mapping configuration | Source configuration |
| ProcessingDashboardPage | Processing job monitoring | Processing flow |
| DatasetDownloadPage | Dataset export/download | Dataset retrieval |
| + others per spec | - | - |

### Root Cause Analysis
The GPT:
1. Implemented core pages but stopped before completing all pages
2. May have hit token/context limits
3. May have deprioritized "secondary" pages

### Recommended Prompt Improvements

```markdown
## UI Page Coverage Rules

1. **Create page checklist from UI Specification:**
   Before starting, list ALL pages from 05-UI-SPECIFICATION.md

2. **Minimum viable pages for each flow:**

   **Auth Flow:**
   - [ ] LoginPage
   - [ ] RegisterPage
   - [ ] ForgotPasswordPage
   - [ ] ResetPasswordPage
   - [ ] AcceptInvitePage  <- OFTEN MISSED

   **Project Flow:**
   - [ ] DashboardPage (project list)
   - [ ] ProjectCreatePage
   - [ ] ProjectDetailPage

   **Source Flow:**
   - [ ] SourceUploadPage or integrated in ProjectDetail
   - [ ] SourceMappingPage (configuration)

   **Processing Flow:**
   - [ ] ProcessingDashboardPage (job status)
   - [ ] DatasetDownloadPage (results)

   **Settings:**
   - [ ] ProfileSettingsPage
   - [ ] TeamManagementPage (if multi-tenant)

3. **Verification:**
   ```bash
   ls -la client/src/pages/**/*.tsx | wc -l
   ```
   Compare to UI spec page count.
```

---

## Issue Category 8: Configuration Gaps

### What Happened
Vite configuration was missing the `watch.ignored` setting.

### Missing Configuration

```typescript
// vite.config.ts - current
server: {
  watch: {
    usePolling: true,
    interval: 1000,
    // ignored: MISSING
  },
}

// vite.config.ts - required
server: {
  watch: {
    usePolling: true,
    interval: 1000,
    ignored: ['**/node_modules/**', '**/.git/**', '**/dist/**'],
  },
}
```

### Root Cause Analysis
The GPT:
1. Included some Replit-specific settings but missed others
2. May not have had complete Replit configuration requirements

### Recommended Prompt Improvements

```markdown
## Replit Configuration Checklist (CRITICAL for Replit deployment)

1. **vite.config.ts required settings:**
   ```typescript
   server: {
     host: '0.0.0.0',           // Required: bind to all interfaces
     port: 5000,                 // Required: Replit's exposed port
     strictPort: true,           // Required: fail if port unavailable
     proxy: {
       '/api': {
         target: 'http://localhost:5001',  // Backend port
         changeOrigin: true,
       },
     },
     watch: {
       usePolling: true,         // Required: Replit filesystem
       interval: 1000,           // Recommended: reduce CPU usage
       ignored: ['**/node_modules/**', '**/.git/**', '**/dist/**'],  // REQUIRED
     },
   },
   ```

2. **.replit required settings:**
   ```toml
   run = "npm run dev"

   [deployment]
   run = ["npm", "run", "start"]
   deploymentTarget = "cloudrun"

   [[ports]]
   localPort = 5000
   externalPort = 80
   ```

3. **Validation:**
   Check each setting exists in the config files before considering complete.
```

---

## Summary: Prompt Engineering Recommendations

### Priority 1: Add Syntax Validation Rules
- Route path validation (slashes before params)
- HTTP method cross-reference with API Contract
- Parameter parsing utility usage

### Priority 2: Add Completeness Checklists
- Endpoint coverage verification
- UI page coverage verification
- Configuration setting verification

### Priority 3: Add Quality Gates
- TODO prohibition in production code
- Security implementation requirements (encryption)
- Consistent utility usage enforcement

### Priority 4: Add Cross-Reference Requirements
- Always check API Contract for HTTP methods
- Always check UI Spec for required pages
- Always check QA-Deployment for configuration

---

## Appendix: Validation Commands for Agents

```bash
# Route path validation - should return 0 results
grep -rn "router\.\(get\|post\|put\|patch\|delete\).*'[^/]" server/routes/

# Missing slashes before params - should return 0 results
grep -rn ":[a-zA-Z]*'" server/routes/ | grep -v "/:"

# TODO comments - should return 0 results in implementation files
grep -rn "// TODO:" server/ client/src/ --include="*.ts" --include="*.tsx"

# Direct parseInt on params - should return 0 results
grep -rn "parseInt(req\.params" server/routes/

# Endpoint count verification
api_spec_count=$(grep -E "^\| [0-9]+ \|" docs/04-API-CONTRACT.md | wc -l)
impl_count=$(grep -rn "router\.\(get\|post\|put\|patch\|delete\)" server/routes/ | wc -l)
echo "Spec: $api_spec_count, Implemented: $impl_count"

# Page count verification
spec_pages=$(grep -c "Page Component" docs/05-UI-SPECIFICATION.md)
impl_pages=$(find client/src/pages -name "*.tsx" | wc -l)
echo "Spec: $spec_pages, Implemented: $impl_pages"
```

---

## Document Metadata

| Field | Value |
|-------|-------|
| Author | Code Review Agent v25 |
| Based On | Audit of Foundry repository |
| Total Issues Analyzed | 21 |
| Categories Identified | 8 |
| Recommendations | 15+ specific prompt improvements |

---

**End of Improvement Brief**
